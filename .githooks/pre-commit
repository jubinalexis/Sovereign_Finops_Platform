#!/bin/sh
# Pre-commit hook to prevent committing secrets
# Install: ln -sf ../../.githooks/pre-commit .git/hooks/pre-commit
# Or on Windows: Copy-Item .githooks/pre-commit .git/hooks/pre-commit

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "${GREEN}Running pre-commit security checks...${NC}"

# Check if gitleaks is installed
if command -v gitleaks >/dev/null 2>&1; then
    echo "  → Scanning for secrets with gitleaks..."
    
    # Run gitleaks on staged files
    if ! gitleaks protect --staged --verbose; then
        echo "${RED}❌ COMMIT BLOCKED: Secrets detected!${NC}"
        echo "${YELLOW}Gitleaks found potential secrets in your staged files.${NC}"
        echo "  1. Review the output above"
        echo "  2. Remove the secrets from your files"
        echo "  3. Use environment variables or secret management instead"
        echo "  4. If this is a false positive, add to .gitleaksignore"
        echo ""
        echo "To bypass this check (NOT RECOMMENDED):"
        echo "  git commit --no-verify"
        exit 1
    fi
    echo "${GREEN}  ✓ No secrets detected${NC}"
else
    echo "${YELLOW}  ⚠ Gitleaks not installed - secret scanning skipped${NC}"
    echo "    Install with:"
    echo "      - Windows: winget install gitleaks"
    echo "      - macOS: brew install gitleaks"
    echo "      - Linux: curl -sSfL https://raw.githubusercontent.com/gitleaks/gitleaks/master/scripts/install.sh | sh"
fi

# Simple regex-based checks for common patterns
echo "  → Running basic pattern checks..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Patterns to detect
PATTERNS=(
    'AKIA[0-9A-Z]{16}:AWS Access Key'
    'AIza[0-9A-Za-z\-_]{35}:Google API Key'
    '(password|passwd|pwd)\s*[:=]\s*["\047]?[^\s"\047]{8,}:Password'
    'sk-[a-zA-Z0-9]{20,}:OpenAI API Key'
    'ghp_[a-zA-Z0-9]{36}:GitHub Personal Access Token'
    'glpat-[a-zA-Z0-9\-_]{20,}:GitLab Token'
    '-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----:Private Key'
)

PATTERN_FOUND=0

for file in $STAGED_FILES; do
    # Skip binary files and large files
    if [ -f "$file" ] && [ -r "$file" ]; then
        for pattern_def in "${PATTERNS[@]}"; do
            pattern="${pattern_def%%:*}"
            name="${pattern_def##*:}"
            
            if grep -qiE "$pattern" "$file" 2>/dev/null; then
                echo "${RED}  ❌ Potential $name found in: $file${NC}"
                PATTERN_FOUND=1
            fi
        done
    fi
done

if [ $PATTERN_FOUND -eq 1 ]; then
    echo "${RED}❌ COMMIT BLOCKED: Potential secrets detected!${NC}"
    echo "${YELLOW}Review the files above and remove any sensitive data.${NC}"
    exit 1
fi

# Check for AWS credentials file
if echo "$STAGED_FILES" | grep -q "\.aws/credentials"; then
    echo "${RED}❌ COMMIT BLOCKED: AWS credentials file detected!${NC}"
    echo "Never commit .aws/credentials file to Git!"
    exit 1
fi

# Check for environment files with secrets
if echo "$STAGED_FILES" | grep -qE "\.env$|\.env\.local$|\.env\.production$"; then
    echo "${YELLOW}⚠ Warning: .env file detected in commit${NC}"
    echo "Ensure this file doesn't contain real secrets!"
    echo "Consider using .env.example instead for templates"
fi

echo "${GREEN}  ✓ Basic pattern checks passed${NC}"

# Check for large files (> 10MB)
echo "  → Checking file sizes..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 10485760 ]; then
            echo "${RED}  ❌ Large file detected: $file ($(numfmt --to=iec-i --suffix=B $size))${NC}"
            echo "${YELLOW}Files over 10MB should not be committed to Git.${NC}"
            echo "Consider using Git LFS: git lfs track \"$file\""
            exit 1
        fi
    fi
done
echo "${GREEN}  ✓ No large files detected${NC}"

echo "${GREEN}✅ All pre-commit checks passed!${NC}"
exit 0
